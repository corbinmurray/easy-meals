name: Build and Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      build_api:
        description: "Build API"
        required: false
        type: boolean
        default: true
      build_web:
        description: "Build Web"
        required: false
        type: boolean
        default: true
      build_recipe_engine:
        description: "Build Recipe Engine"
        required: false
        type: boolean
        default: true
      deploy:
        description: "Deploy to production"
        required: false
        type: boolean
        default: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Detect what changed to only build what's needed
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.filter.outputs.api || steps.manual.outputs.api || steps.filter.outputs.deployment-infra }}
      web: ${{ steps.filter.outputs.web || steps.manual.outputs.web || steps.filter.outputs.deployment-infra }}
      recipe-engine: ${{ steps.filter.outputs.recipe-engine || steps.manual.outputs.recipe-engine || steps.filter.outputs.deployment-infra }}
    steps:
      - uses: actions/checkout@v4

      - name: Check manual trigger
        id: manual
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "api=${{ inputs.build_api }}" >> $GITHUB_OUTPUT
          echo "web=${{ inputs.build_web }}" >> $GITHUB_OUTPUT
          echo "recipe-engine=${{ inputs.build_recipe_engine }}" >> $GITHUB_OUTPUT

      - uses: dorny/paths-filter@v2
        id: filter
        if: github.event_name != 'workflow_dispatch'
        with:
          filters: |
            # Deployment infrastructure changes trigger rebuild of all apps
            deployment-infra:
              - 'docker-compose.yml'
              - 'apps/**/Dockerfile'
              - '.github/workflows/deploy.yml'
            api:
              - 'apps/api/**'
              - 'packages/shared/**'
            web:
              - 'apps/web/**'
              - 'packages/ui/**'
              - 'packages/typescript-config/**'
              - 'packages/eslint-config/**'
            recipe-engine:
              - 'apps/recipe-engine/**'
              - 'packages/shared/**'

  # Build Docker images using matrix strategy
  build:
    runs-on: ubuntu-latest
    needs: detect-changes
    # Skip the entire matrix if none of the apps changed
    if: |
      needs.detect-changes.outputs.api == 'true' ||
      needs.detect-changes.outputs.web == 'true' ||
      needs.detect-changes.outputs.recipe-engine == 'true'
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        include:
          - name: api
            dockerfile: apps/api/src/EasyMeals.Api/Dockerfile
            should-build: ${{ needs.detect-changes.outputs.api == 'true' }}
          - name: web
            dockerfile: apps/web/Dockerfile
            should-build: ${{ needs.detect-changes.outputs.web == 'true' }}
          - name: recipe-engine
            dockerfile: apps/recipe-engine/src/EasyMeals.RecipeEngine/Dockerfile
            should-build: ${{ needs.detect-changes.outputs.recipe-engine == 'true' }}
    steps:
      - name: Check if build needed
        id: check
        run: |
          if [ "${{ matrix.should-build }}" == "true" ]; then
            echo "Building ${{ matrix.name }}..."
            echo "skip=false" >> $GITHUB_OUTPUT
          else
            echo "Skipping ${{ matrix.name }} (no changes)"
            echo "skip=true" >> $GITHUB_OUTPUT
          fi

      - uses: actions/checkout@v4
        if: steps.check.outputs.skip == 'false'

      - name: Set up Docker Buildx
        if: steps.check.outputs.skip == 'false'
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        if: steps.check.outputs.skip == 'false'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        if: steps.check.outputs.skip == 'false'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.name }}
          tags: |
            type=sha
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push ${{ matrix.name }}
        if: steps.check.outputs.skip == 'false'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: |
      always() &&
      (github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && inputs.deploy == true)) &&
      (needs.build.result == 'success' || needs.build.result == 'skipped')
    steps:
      - name: Trigger Coolify deployment
        env:
          COOLIFY_API_TOKEN: ${{ secrets.COOLIFY_API_TOKEN }}
          COOLIFY_WEBHOOK_EASYMEALS: ${{ secrets.COOLIFY_WEBHOOK_EASYMEALS }}
        run: |
          # Triggers Coolify to pull latest images and restart services
          # Uses Coolify API with authentication for better security and error handling

          response=$(curl -s -w "\n%{http_code}" -X GET \
            "${COOLIFY_WEBHOOK_EASYMEALS}" \
            -H "Authorization: Bearer ${COOLIFY_API_TOKEN}" \
            -H "Content-Type: application/json")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "HTTP Status: $http_code"
          echo "Response: $body"

          if [ "$http_code" -eq 200 ]; then
            echo "âœ… Deployment triggered successfully"
          else
            echo "âŒ Deployment failed with status $http_code"
            exit 1
          fi

      - name: Deployment summary
        run: |
          echo "### Deployment Triggered! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Changed apps will be redeployed:" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.detect-changes.outputs.api }}" == "true" ]; then
            echo "- âœ… API (new image)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â­ï¸ API (no changes)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.detect-changes.outputs.web }}" == "true" ]; then
            echo "- âœ… Web (new image)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â­ï¸ Web (no changes)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.detect-changes.outputs.recipe-engine }}" == "true" ]; then
            echo "- âœ… Recipe Engine (new image)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â­ï¸ Recipe Engine (no changes)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Coolify will restart only the services with new images." >> $GITHUB_STEP_SUMMARY
